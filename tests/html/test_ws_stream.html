<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>WebSocket Stream Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .video-container {
            flex: 1;
        }
        .result-container {
            flex: 1;
        }
        video, canvas {
            width: 100%;
            max-width: 480px;
            border: 2px solid #333;
            border-radius: 8px;
        }
        #status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .error { background-color: #fff3cd; color: #856404; }
        #results {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            min-height: 200px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
        }
        .controls {
            margin: 15px 0;
        }
        .slider-group {
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .slider-group label {
            min-width: 120px;
        }
        .slider-group input[type="range"] {
            flex: 1;
        }
        .slider-group span {
            min-width: 50px;
            text-align: right;
        }
        .fps-display {
            font-size: 14px;
            color: #666;
            margin: 5px 0;
        }
        .connection-info {
            font-size: 14px;
            color: #666;
            margin: 5px 0;
            padding: 10px;
            background: #e9ecef;
            border-radius: 4px;
        }
    </style>
</head>
<body>
<h1>WebSocket Stream Test - /ws/rooms/{room_id}/stream</h1>

<div class="disconnected" id="status">Status: Disconnected</div>

<div class="connection-info" id="connectionInfo">Connection URL: -</div>

<div class="controls">
    <div class="slider-group">
        <label>Server Address:</label>
        <input id="serverAddress" style="flex:1; padding: 5px;" type="text" value="localhost:8000">
    </div>
    <div class="slider-group">
        <label>Room ID:</label>
        <input id="roomId" style="flex:1; padding: 5px;" type="text" value="test_room">
    </div>
    <div class="slider-group">
        <label>Client Name:</label>
        <input id="clientName" style="flex:1; padding: 5px;" type="text" value="test_client">
    </div>
</div>

<div class="controls">
    <button id="connectBtn">Connect</button>
    <button disabled id="disconnectBtn">Disconnect</button>
    <button id="startVideoBtn">Start Video</button>
    <button disabled id="stopVideoBtn">Stop Video</button>
</div>

<div class="controls" style="background: #f0f0f0; padding: 15px; border-radius: 8px;">
    <h3>Settings</h3>
    <div class="slider-group">
        <label>Resolution:</label>
        <input id="resolutionSlider" max="640" min="160" step="80" type="range" value="320">
        <span id="resolutionValue">320x240</span>
    </div>
    <div class="slider-group">
        <label>Cam FPS:</label>
        <input id="camFpsSlider" max="30" min="5" step="1" type="range" value="15">
        <span id="camFpsValue">15</span>
    </div>
    <div class="slider-group">
        <label>Send FPS:</label>
        <input id="sendFpsSlider" max="30" min="5" step="1" type="range" value="20">
        <span id="sendFpsValue">20</span>
    </div>
    <div class="slider-group">
        <label>JPEG Quality:</label>
        <input id="qualitySlider" max="1.0" min="0.1" step="0.05" type="range" value="0.3">
        <span id="qualityValue">0.30</span>
    </div>
    <div class="fps-display">
        <strong>Send FPS:</strong> <span id="actualSendFps">0</span> |
        <strong>Receive FPS:</strong> <span id="actualReceiveFps">0</span>
    </div>
</div>

<div class="container">
    <div class="video-container">
        <h3>Original Video</h3>
        <video autoplay id="video" playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
    </div>
    <div class="result-container">
        <h3>Processed Frame</h3>
        <canvas id="resultCanvas"></canvas>
        <h3>Analysis Results</h3>
        <div id="results">No results yet...</div>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const resultCanvas = document.getElementById('resultCanvas');
    const ctx = canvas.getContext('2d');
    const resultCtx = resultCanvas.getContext('2d');
    const status = document.getElementById('status');
    const results = document.getElementById('results');

    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const startVideoBtn = document.getElementById('startVideoBtn');
    const stopVideoBtn = document.getElementById('stopVideoBtn');

    const resolutionSlider = document.getElementById('resolutionSlider');
    const resolutionValue = document.getElementById('resolutionValue');
    const camFpsSlider = document.getElementById('camFpsSlider');
    const camFpsValue = document.getElementById('camFpsValue');
    const sendFpsSlider = document.getElementById('sendFpsSlider');
    const sendFpsValue = document.getElementById('sendFpsValue');
    const qualitySlider = document.getElementById('qualitySlider');
    const qualityValue = document.getElementById('qualityValue');
    const actualSendFps = document.getElementById('actualSendFps');
    const actualReceiveFps = document.getElementById('actualReceiveFps');
    const connectionInfo = document.getElementById('connectionInfo');

    let ws = null;
    let isStreaming = false;
    let streamInterval = null;
    let frameCount = 0;
    let lastFpsUpdate = Date.now();
    let frameCountForFps = 0;
    let lastReceiveTime = Date.now();
    let receiveCount = 0;
    let maxPendingFrames = 3;
    let pendingFrames = 0;

    const serverAddress = document.getElementById('serverAddress');
    const roomIdInput = document.getElementById('roomId');
    const clientNameInput = document.getElementById('clientName');

    resolutionSlider.addEventListener('input', () => {
        const w = parseInt(resolutionSlider.value);
        const h = Math.round(w * 0.75);
        resolutionValue.textContent = `${w}x${h}`;
    });

    camFpsSlider.addEventListener('input', () => {
        camFpsValue.textContent = camFpsSlider.value;
    });

    sendFpsSlider.addEventListener('input', () => {
        sendFpsValue.textContent = sendFpsSlider.value;
        if (isStreaming) {
            restartStreaming();
        }
    });

    qualitySlider.addEventListener('input', () => {
        qualityValue.textContent = parseFloat(qualitySlider.value).toFixed(2);
    });

    function restartStreaming() {
        stopStreaming();
        startSendingFrames();
    }

    function updateFpsDisplay() {
        const now = Date.now();
        const elapsed = (now - lastFpsUpdate) / 1000;
        if (elapsed >= 1) {
            actualSendFps.textContent = Math.round(frameCountForFps / elapsed);
            actualReceiveFps.textContent = Math.round(receiveCount / elapsed);
            frameCountForFps = 0;
            receiveCount = 0;
            lastFpsUpdate = now;
        }
    }

    function updateStatus(message, className) {
        status.textContent = 'Status: ' + message;
        status.className = className;
    }

    connectBtn.addEventListener('click', () => {
        const serverUrl = 'ws://' + serverAddress.value;
        const roomId = roomIdInput.value || 'test_room';
        const clientName = clientNameInput.value;
        const wsUrl = `${serverUrl}/ws/rooms/${roomId}/stream?name=${encodeURIComponent(clientName)}`;
        
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            updateStatus('Connected', 'connected');
            connectionInfo.textContent = 'Connection URL: ' + wsUrl;
            connectBtn.disabled = true;
            disconnectBtn.disabled = false;
        };

        ws.onclose = () => {
            updateStatus('Disconnected', 'disconnected');
            connectionInfo.textContent = 'Connection URL: -';
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
            pendingFrames = 0;
            stopStreaming();
        };

        ws.onerror = (error) => {
            updateStatus('Error: ' + error.message, 'error');
        };

        ws.onmessage = (event) => {
            receiveCount++;
            if (pendingFrames > 0) pendingFrames--;
            try {
                const data = JSON.parse(event.data);
                if (data.error) {
                    results.textContent = 'Error: ' + data.error;
                    console.error('Server error:', data.error);
                } else {
                    displayProcessedImage(data.image, data.results);
                }
            } catch (e) {
                console.error('Failed to parse message:', e);
                results.textContent = 'Parse Error: ' + e.message;
            }
        };
    });

    disconnectBtn.addEventListener('click', () => {
        if (ws) {
            ws.close();
        }
    });

    startVideoBtn.addEventListener('click', async () => {
        try {
            const width = parseInt(resolutionSlider.value);
            const height = Math.round(width * 0.75);
            const fps = parseInt(camFpsSlider.value);
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { width: width, height: height, frameRate: fps }
            });
            video.srcObject = stream;
            isStreaming = true;
            startVideoBtn.disabled = true;
            stopVideoBtn.disabled = false;

            video.onloadedmetadata = () => {
                console.log('Video metadata loaded, dimensions:', video.videoWidth, 'x', video.videoHeight);
                if (ws && ws.readyState === WebSocket.OPEN) {
                    console.log('Starting frame sending...');
                    startSendingFrames();
                } else {
                    console.log('WS not ready, state:', ws?.readyState);
                }
            };
        } catch (err) {
            updateStatus('Camera Error: ' + err.message, 'error');
            console.error('Camera error:', err);
        }
    });

    stopVideoBtn.addEventListener('click', () => {
        stopStreaming();
        const tracks = video.srcObject?.getTracks();
        tracks?.forEach(track => track.stop());
        video.srcObject = null;
        startVideoBtn.disabled = false;
        stopVideoBtn.disabled = true;
    });

    function startSendingFrames() {
        if (streamInterval) return;

        const intervalMs = Math.round(1000 / parseInt(sendFpsSlider.value));

        streamInterval = setInterval(() => {
            if (!isStreaming || !ws || ws.readyState !== WebSocket.OPEN) return;
            if (pendingFrames >= maxPendingFrames) return;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            const quality = parseFloat(qualitySlider.value);
            const imageData = canvas.toDataURL('image/jpeg', quality);
            const base64Data = imageData.split(',')[1];

            ws.send(JSON.stringify({ image: base64Data }));
            pendingFrames++;
            frameCount++;
            frameCountForFps++;
            updateFpsDisplay();
        }, intervalMs);
    }

    function stopStreaming() {
        isStreaming = false;
        if (streamInterval) {
            clearInterval(streamInterval);
            streamInterval = null;
        }
    }

    function displayProcessedImage(base64Image, analysisResults) {
        const img = new Image();
        img.onload = () => {
            resultCanvas.width = img.width;
            resultCanvas.height = img.height;
            resultCtx.drawImage(img, 0, 0);
        };
        img.src = 'data:image/jpeg;base64,' + base64Image;

        results.textContent = JSON.stringify(analysisResults, null, 2);
    }
</script>
</body>
</html>
